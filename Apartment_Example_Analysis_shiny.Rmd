---
title: "Clustering Example Shiny"
author: "Oliver Summers"
date: "16/11/2020"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)

library(bearing)
library(dplyr)
library(sf)
library(ggplot2)
library(summarytools)
library(kableExtra)
library(shiny)
library(leaflet)
library(DT)
```

## Load Dataset

```{r echo=FALSE}
inputPanel(
  fileInput('data',
            label = 'Property Data',
            accept = c('.rds','.RData')
  )
)

apt <- reactive({
    readRDS(input$data$datapath) %>% 
      janitor::clean_names()
})

renderUI({
  inputPanel(
    selectInput(
      'id',
      label = 'Select property id variable name',
      choices = colnames(apt())
    ),
    selectInput(
      'address',
      label = 'Select property address variable name',
      choices = colnames(apt())
    )
  )
})

```


## Choose the variables to use in the clustering algorithm:
```{r echo=FALSE}
renderUI({
  inputPanel(
    selectInput('variables',
                label= "Clustering Variables",
                choices = colnames(apt()),
                multiple = TRUE
    )
  )
})
```

## Select if variables are numeric or categorical
```{r echo=FALSE}
renderUI({
  inputPanel(
  conditionalPanel(
    condition = "input['variables'].length > 0",
    checkboxGroupInput("numeric_variables",
                      label = "Numeric Variables",
                      choices = input$variables,
                      # multiple = TRUE
                      )
  ),
  conditionalPanel(
    condition = "input['variables'].length > 0",
    checkboxGroupInput("categorical_variables",
                      label = "Categorical Variables",
                      choices = input$variables,
                      # multiple = TRUE
                      )
  )
)
})
```

## Select the Subject Property
```{r include=FALSE}
non_na <- reactive({
  apt() %>% dplyr::rename(apn = input$id,
                          address = input$address) %>%
    select(c(input$variables, 'apn', 'latitude','longitude','address')) %>%
    na.omit() 
})

```


```{r echo=FALSE}
renderUI({
  inputPanel(
    selectInput('apn', label= "Property ID", choices = non_na() %>% select(apn) %>% unique())
    )
})
```


```{r include=FALSE}
subject <- reactive({
  subj_data <- non_na() %>%
    dplyr::filter(apn == input$apn)
  
  list(subject_lat = subj_data$latitude, 
       subject_lng = subj_data$longitude, 
       subject_apn = subj_data$apn)
})
```

## Initial Leaflet Plot - Dataset A

This plot includes all of the properties in the dataset.

```{r echo=FALSE}
renderLeaflet({
  leaflet_plot(non_na(), subject_lat = subject()$subject_lat, subject_lng = subject()$subject_lng)
})
```

## Clustered properties - Dataset B

```{r include=FALSE}
clustered <- reactive({
  apt <- non_na() %>%
    mutate(across(input$numeric_variables, as.numeric),
          across(input$categorical_variables, as.factor)) %>%
    reproject_latlon()
    
  set.seed(100)

  m <- optimal_m(apt %>% select(-c(lon,lat,apn,address)),
                 m_values = 4:10,
                 n_start = 1)
  
  clusters <- cknn(
      data = apt %>% select(-c(lon,lat,apn,address)),
      lon = apt %>% pull(lon),
      lat = apt %>% pull(lat),
      m = m,
      k = input$k,
      l = input$l
    )

  sales_with_knn <- recombine_data_knn(apt, clusters)
  
  # reproject lat/lon to GPS coordinates - use colorado
  sales_with_knn <- reproject_latlon(sales_with_knn, old_crs = 3502, new_crs = 4326) %>%
    rename(latitude = lat,
           longitude = lon)
  
  sales_with_knn
})
```


This dataset includes the subject property and the other properties in its cluster.

```{r echo=FALSE}
renderText({
  sales_with_knn <- clustered()
  sapn <-subject()$subject_apn
  subj_cluster <- get_subj_cluster(sales_with_knn, subject_apn = sapn)

  paste('The subject property is in cluster ', subj_cluster)
})
```


### Summary stats of cluster

We can then explore the summary statistics of the subject properties cluster, as well as compare to other clusters via histograms and boxplots. I have chosen to analyse PriceSold, but other variables can also be examined.


```{r echo=FALSE}
renderDataTable({
  sales_with_knn <- clustered()
  
  subj_cluster <- get_subj_cluster(sales_with_knn, subject_apn = subject()$subject_apn)

  sales_with_knn %>%
    filter(m == subj_cluster) %>%
    select(-c(knn,latitude,longitude, m)) %>%
    summarytools::descr()

})
```


### Choose variable:

```{r echo=FALSE}
renderUI({
  inputPanel(
    radioButtons(
      inputId = 'plot_variable',
      label = 'Variable to plot',
      choices = input$numeric_variables
    )
  )
})
```

```{r echo=FALSE}
renderPlot({
  facet_boxplot(clustered(), variable = input$plot_variable)
})
```

```{r echo=FALSE}
renderPlot({
  facet_hist(clustered(), variable = input$plot_variable)
})
```

### Plot same cluster apartments

This plot shows the subject property and other properties that were found to be in the same cluster as it.
```{r echo=FALSE}
renderLeaflet({
  sapn <- subject()$subject_apn
  data <- clustered()
  sc <- get_subj_cluster(data, subject_apn = sapn)
  
  bearing::leaflet_plot(data %>% dplyr::filter(m == sc),
                        subject_lat = subject()$subject_lat,
                        subject_lng = subject()$subject_lng)
})
```

## Nearest Neighbours - Dataset C

This dataset includes the subject property and it's nearest neighbours from the knn algorithm.


### Select importance of distance and number of nearest neighbours:

Distance importance is a hyperparameter representing the trade-off between distance and characteristics in the kNN matching. A value equal to 1 will match on distance only, while value equal to 0 will disregard distance and match on characteristics only.

```{r echo=FALSE}
inputPanel(
  sliderInput('l',
              label= "Importance of distance",
              min=0,
              max=1,
              value=0.5
  ),
  sliderInput('k',
              label = 'Number of nearest neighbours',
              min=1,
              max=15,
              value = 10,
              step=1)
)
```


### NN summary stats
```{r echo=FALSE}
renderDataTable({
  sales_nn <- get_nn(clustered(), subject_apn = subject()$subject_apn)
  
  sales_nn %>%
    select(-c(knn,latitude,longitude, m)) %>% 
    summarytools::descr()
})
```

### Choose variable:
```{r echo=FALSE}
renderUI({
  inputPanel(
    radioButtons(
      inputId = 'plot_variable_nn',
      label = 'Variable to plot',
      choices = input$numeric_variables
    )
  )
})
```

### NN analysis
```{r echo=FALSE}
renderDataTable({
  get_nn(clustered(), subject_apn = subject()$subject_apn) %>% 
    select(-c(apn,m,latitude,longitude,knn))
})
```

```{r echo=FALSE}
renderPlot({
  sales_nn <- get_nn(clustered(), subject_apn = subject()$subject_apn)
  
  facet_hist(sales_nn, variable = input$plot_variable_nn)
})
```

```{r echo=FALSE}
renderPlot({
  sales_nn <- get_nn(clustered(), subject_apn = subject()$subject_apn)
  
  facet_boxplot(sales_nn, variable = input$plot_variable_nn)
})
```

### Plot nearest neighbours

```{r echo=FALSE}
renderLeaflet({
  sales_nn <- get_nn(clustered(), subject_apn = subject()$subject_apn)
  
  bearing::leaflet_plot(sales_nn,
                        subject_lat = subject()$subject_lat,
                        subject_lng = subject()$subject_lng)
})
```
